<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Reset your Teengro password and regain access to your account." />
  <title>Reset Password | Teengro</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Plus Jakarta Sans', system-ui, sans-serif; }

    .auth-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 24px 48px;
    }
    .auth-card {
      width: 100%;
      max-width: 400px;
      border-radius: 16px;
      padding: 36px 32px;
    }
    body[data-theme="dark"]  .auth-card { background: #0d1117; border: 1px solid rgba(255,255,255,0.07); }
    body[data-theme="light"] .auth-card { background: #ffffff; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 24px rgba(0,0,0,0.07); }

    .auth-card h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 6px; }
    .auth-card .auth-sub { font-size: 0.88rem; opacity: 0.45; margin-bottom: 28px; }

    .auth-divider { height: 1px; margin-bottom: 24px; }
    body[data-theme="dark"]  .auth-divider { background: rgba(255,255,255,0.07); }
    body[data-theme="light"] .auth-divider { background: rgba(0,0,0,0.07); }

    .auth-message { font-size: 0.83rem; padding: 10px 12px; border-radius: 8px; margin-bottom: 16px; display: none; }
    .auth-message.error   { background: rgba(239,68,68,0.12); color: #f87171; display: block; }
    .auth-message.success { background: rgba(16,185,129,0.12); color: #34d399; display: block; }
    .auth-message.info    { background: rgba(59,130,246,0.12); color: #60a5fa; display: block; }

    .auth-form { display: flex; flex-direction: column; gap: 14px; }
    .auth-field { display: flex; flex-direction: column; gap: 6px; }
    .auth-field label {
      font-size: 0.78rem; font-weight: 600;
      letter-spacing: 0.05em; text-transform: uppercase; opacity: 0.45;
    }

    /* Password field with eye INSIDE the border */
    .pw-field {
      display: flex;
      align-items: center;
      border-radius: 10px;
      border: 1px solid;
      transition: border-color 0.15s;
      overflow: hidden;
    }
    body[data-theme="dark"]  .pw-field { background: #05080b; border-color: rgba(255,255,255,0.1); }
    body[data-theme="light"] .pw-field { background: #f9fafb; border-color: rgba(0,0,0,0.1); }
    body[data-theme="dark"]  .pw-field:focus-within { border-color: rgba(255,255,255,0.28); }
    body[data-theme="light"] .pw-field:focus-within { border-color: rgba(0,0,0,0.28); }

    .pw-field input {
      flex: 1;
      border: none !important;
      background: transparent !important;
      padding: 11px 4px 11px 14px;
      outline: none;
      font-size: 0.9rem;
      font-family: inherit;
      min-width: 0;
    }
    body[data-theme="dark"]  .pw-field input { color: #e5e7eb; }
    body[data-theme="light"] .pw-field input { color: #111827; }
    .pw-field input::placeholder { opacity: 0.32; }

    .pw-eye-btn {
      flex-shrink: 0;
      width: 38px; height: 38px;
      display: flex; align-items: center; justify-content: center;
      background: none; border: none; cursor: pointer;
      color: inherit; opacity: 0.38;
      transition: opacity 0.15s;
      padding: 0;
    }
    .pw-eye-btn:hover { opacity: 0.75; }

    .pw-hint {
      font-size: 0.72rem;
      opacity: 0.4;
      margin-top: 2px;
    }

    .auth-submit {
      padding: 13px; border-radius: 999px; border: none;
      font-size: 0.92rem; font-weight: 600; font-family: inherit;
      cursor: pointer; background: #10b981; color: #020617;
      margin-top: 4px; transition: opacity 0.15s, transform 0.12s;
    }
    .auth-submit:hover  { opacity: 0.88; transform: translateY(-1px); }
    .auth-submit:active { transform: translateY(0); }
    .auth-submit:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .auth-link {
      text-align: center;
      font-size: 0.85rem;
      margin-top: 18px;
      opacity: 0.55;
    }
    .auth-link a {
      font-weight: 600;
      text-decoration: none;
      opacity: 1;
    }
    body[data-theme="dark"]  .auth-link a { color: #e5e7eb; }
    body[data-theme="light"] .auth-link a { color: #111827; }
    .auth-link a:hover { text-decoration: underline; }

    .loading-state {
      text-align: center;
      padding: 40px 20px;
    }
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    body[data-theme="dark"]  .loading-spinner { border-color: rgba(255,255,255,0.2); border-top-color: transparent; }
    body[data-theme="light"] .loading-spinner { border-color: rgba(0,0,0,0.2); border-top-color: transparent; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text {
      font-size: 0.88rem;
      opacity: 0.5;
    }
  </style>
</head>
<body data-theme="dark">

<header class="navbar">
  <div class="logo">
    <img src="logo-dark.png"  class="logo-img logo-dark"  alt="Teengro" />
    <img src="logo-light.png" class="logo-img logo-light" alt="Teengro" />
  </div>
  <div class="nav-right">
    <button class="hamburger" id="menuToggle" aria-label="Menu"><span></span><span></span><span></span></button>
  </div>
  <div class="menu-dropdown" id="menuDropdown">
    <a href="index.html"><svg class="menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Home</a>
    <a href="about.html"><svg class="menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>About Us</a>
    <a href="founder.html"><svg class="menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>Meet the Founder</a>
    <a href="help.html"><svg class="menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Help</a>
    <div class="menu-divider"></div>
    <button id="themeToggleMenu"><svg class="menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>Change theme</button>
    <div class="menu-divider"></div>
    <a href="login.html"><svg class="menu-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>Login</a>
  </div>
</header>

<div class="auth-shell">
  <div class="auth-card">
    <!-- Loading state -->
    <div id="loadingState" class="loading-state">
      <div class="loading-spinner"></div>
      <p class="loading-text" id="loadingText">Verifying reset link...</p>
      <p style="font-size: 0.75rem; opacity: 0.4; margin-top: 12px;" id="loadingSubtext">Checking token...</p>
    </div>

    <!-- Reset form (hidden initially) -->
    <div id="resetFormContainer" style="display: none;">
      <h1>Reset Password</h1>
      <p class="auth-sub">Enter your new password below.</p>
      <div class="auth-divider"></div>
      <div id="authMessage" class="auth-message"></div>
      <form class="auth-form" onsubmit="resetPassword(event)">
        <div class="auth-field">
          <label>New Password</label>
          <div class="pw-field">
            <input type="password" id="newPassword" placeholder="At least 6 characters" required minlength="6" autocomplete="new-password" />
            <button type="button" class="pw-eye-btn" id="pwToggle1" title="Show / hide password">
              <svg class="eye-icon" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="auth-field">
          <label>Confirm Password</label>
          <div class="pw-field">
            <input type="password" id="confirmPassword" placeholder="Re-enter password" required minlength="6" autocomplete="new-password" />
            <button type="button" class="pw-eye-btn" id="pwToggle2" title="Show / hide password">
              <svg class="eye-icon" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
          <p class="pw-hint">Must match the password above</p>
        </div>
        <button type="submit" class="auth-submit" id="resetBtn">Reset Password</button>
      </form>
    </div>

    <!-- Error state (hidden initially) -->
    <div id="errorState" style="display: none;">
      <h1>Invalid Reset Link</h1>
      <p class="auth-sub">This password reset link is invalid or has expired.</p>
      <div class="auth-divider"></div>
      <div class="auth-message error" id="errorMessage">
        The reset link may have expired or already been used. Please request a new password reset link.
      </div>
      <p class="auth-link"><a href="login.html">‚Üê Back to Login</a></p>
    </div>
  </div>
</div>

<footer class="about-footer">¬© 2026 Teengro. Built by a teen, for teens.</footer>

<script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   THEME (standalone - no script.js)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const savedTheme = localStorage.getItem("theme") || "dark";
document.documentElement.setAttribute("data-theme", savedTheme);

// Theme toggle
document.getElementById('themeToggleMenu')?.addEventListener('click', function() {
  const current = document.documentElement.getAttribute('data-theme');
  const newTheme = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
});

// Menu toggle
const menuToggle = document.getElementById('menuToggle');
const menuDropdown = document.getElementById('menuDropdown');
menuToggle?.addEventListener('click', () => {
  menuToggle.classList.toggle('active');
  menuDropdown.classList.toggle('active');
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   SUPABASE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const SUPABASE_URL = "https://ctquajydjitfjhqvezfz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0cXVhanlkaml0ZmpocXZlemZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MjA1MzQsImV4cCI6MjA4MzE5NjUzNH0.3cenuqB4XffJdRQisJQhq7PS9_ybXDN7ExbsKfXx9gU";

let supabaseClient = null;

// Password toggle functionality
function setupPasswordToggle(buttonId, inputId) {
  const button = document.getElementById(buttonId);
  const input = document.getElementById(inputId);
  const icon = button?.querySelector('.eye-icon');
  
  if (!button || !input || !icon) return;
  
  button.addEventListener('click', function() {
    const isPassword = input.type === 'password';
    input.type = isPassword ? 'text' : 'password';
    
    icon.innerHTML = isPassword
      ? '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19M1 1l22 22"/>'
      : '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
  });
}

setupPasswordToggle('pwToggle1', 'newPassword');
setupPasswordToggle('pwToggle2', 'confirmPassword');

// Check for access token on page load
window.addEventListener('load', async function() {
  console.log('üöÄ Page loaded, starting token verification...');
  
  const loadingState = document.getElementById('loadingState');
  const resetFormContainer = document.getElementById('resetFormContainer');
  const errorState = document.getElementById('errorState');
  const loadingText = document.getElementById('loadingText');
  const loadingSubtext = document.getElementById('loadingSubtext');
  
  function updateLoading(main, sub) {
    if (loadingText) loadingText.textContent = main;
    if (loadingSubtext) loadingSubtext.textContent = sub;
    console.log('üìç', main, '-', sub);
  }
  
  // Wait for Supabase library to load
  updateLoading('Initializing...', 'Loading authentication library...');
  
  let attempts = 0;
  const maxAttempts = 50;
  
  while (typeof supabase === 'undefined' && attempts < maxAttempts) {
    await new Promise(resolve => setTimeout(resolve, 100));
    attempts++;
  }
  
  if (typeof supabase === 'undefined') {
    console.error('‚úó Supabase library failed to load');
    loadingState.style.display = 'none';
    errorState.style.display = 'block';
    const errorMsg = document.getElementById('errorMessage');
    if (errorMsg) {
      errorMsg.textContent = 'Failed to initialize. Please refresh the page or try again later.';
    }
    return;
  }
  
  console.log('‚úì Supabase library loaded after', attempts * 100, 'ms');
  supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  console.log('‚úì Supabase client initialized');
  
  // Add timeout for loading state
  const loadingTimeout = setTimeout(() => {
    console.error('‚è±Ô∏è TIMEOUT - Operation took more than 10 seconds');
    updateLoading('Request timed out', 'This is taking too long...');
    setTimeout(() => {
      loadingState.style.display = 'none';
      errorState.style.display = 'block';
      const errorMsg = document.getElementById('errorMessage');
      if (errorMsg) {
        errorMsg.textContent = 'Verification timed out. The link may be invalid or expired. Please try again or request a new reset link.';
      }
    }, 1000);
  }, 10000); // 10 second timeout
  
  try {
    updateLoading('Starting verification...', 'Parsing URL parameters...');
    
    // Get hash parameters from URL (Supabase sends them as #access_token=...)
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = hashParams.get('access_token');
    const refreshToken = hashParams.get('refresh_token');
    const type = hashParams.get('type');
    
    console.log('üîó Full URL:', window.location.href);
    console.log('# Hash:', window.location.hash);
    console.log('üì¶ Parsed params:', { 
      accessToken: accessToken ? '‚úì present (' + accessToken.substring(0, 20) + '...)' : '‚úó missing', 
      refreshToken: refreshToken ? '‚úì present' : '‚úó missing',
      type: type || '‚úó missing'
    });
    
    // Check if this is a valid password recovery link
    if (type === 'recovery' && accessToken) {
      updateLoading('Valid link detected', 'Authenticating...');
      console.log('‚úì Valid recovery link detected, setting session...');
      
      const startTime = Date.now();
      
      // Set the session using the access token with timeout protection
      console.log('‚è≥ Calling setSession...');
      const sessionPromise = supabaseClient.auth.setSession({
        access_token: accessToken,
        refresh_token: refreshToken || ''
      });
      
      const { data, error } = await Promise.race([
        sessionPromise,
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Supabase setSession timed out after 8 seconds')), 8000)
        )
      ]);
      
      const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
      console.log(`‚è±Ô∏è setSession completed in ${elapsed}s`);
      
      clearTimeout(loadingTimeout);
      
      if (error) {
        console.error('‚ùå Session error:', error);
        throw new Error('Invalid or expired reset link: ' + error.message);
      }
      
      if (!data.session) {
        console.error('‚ùå No session in response:', data);
        throw new Error('No session created - token may be invalid');
      }
      
      console.log('‚úÖ Session established successfully');
      console.log('üë§ User email:', data.session.user.email);
      console.log('üîë Session expires:', new Date(data.session.expires_at * 1000).toLocaleString());
      
      updateLoading('Success!', 'Loading password reset form...');
      
      // Valid token - show the reset form
      setTimeout(() => {
        loadingState.style.display = 'none';
        resetFormContainer.style.display = 'block';
      }, 500);
      
    } else {
      // No valid token in URL
      clearTimeout(loadingTimeout);
      console.log('‚ùå No valid recovery token found in URL');
      console.log('Missing required parameters:', { 
        type: type || 'MISSING', 
        hasAccessToken: !!accessToken 
      });
      loadingState.style.display = 'none';
      errorState.style.display = 'block';
    }
  } catch (error) {
    clearTimeout(loadingTimeout);
    console.error('üí• Token verification error:', error);
    console.error('Error details:', {
      message: error.message,
      name: error.name,
      stack: error.stack
    });
    loadingState.style.display = 'none';
    errorState.style.display = 'block';
    const errorMsg = document.getElementById('errorMessage');
    if (errorMsg) {
      errorMsg.textContent = error.message || 'The reset link may have expired or already been used. Please request a new password reset link.';
    }
  }
});

// Reset password function
async function resetPassword(event) {
  event.preventDefault();
  
  if (!supabaseClient) {
    console.error('Supabase client not initialized');
    return;
  }
  
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const authMessage = document.getElementById('authMessage');
  const resetBtn = document.getElementById('resetBtn');
  
  // Clear previous messages
  authMessage.textContent = '';
  authMessage.className = 'auth-message';
  
  // Validate passwords match
  if (newPassword !== confirmPassword) {
    authMessage.textContent = 'Passwords do not match';
    authMessage.classList.add('error');
    return;
  }
  
  // Validate password length
  if (newPassword.length < 6) {
    authMessage.textContent = 'Password must be at least 6 characters';
    authMessage.classList.add('error');
    return;
  }
  
  // Disable button during request
  resetBtn.disabled = true;
  resetBtn.textContent = 'Resetting...';
  
  try {
    // Update the password
    const { data, error } = await supabaseClient.auth.updateUser({
      password: newPassword
    });
    
    if (error) {
      console.error('Update error:', error);
      throw error;
    }
    
    console.log('Password updated successfully');
    
    // Success
    authMessage.textContent = 'Password reset successful! Redirecting to login...';
    authMessage.classList.add('success');
    
    // Sign out and redirect to login after 2 seconds
    setTimeout(async () => {
      await supabaseClient.auth.signOut();
      window.location.href = 'login.html';
    }, 2000);
    
  } catch (error) {
    console.error('Reset error:', error);
    authMessage.textContent = error.message || 'Failed to reset password. Please try again.';
    authMessage.classList.add('error');
    resetBtn.disabled = false;
    resetBtn.textContent = 'Reset Password';
  }
}
</script>
</body>
</html>
